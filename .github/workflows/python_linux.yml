name: Python On Linux
on:
  workflow_call:

jobs:
  test-python-app:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app:
          - name: django-postgres
            path: django-postgres
            script_dir: django_postgres
          - name: flask-mysql
            path: flask-mysql
            script_dir: flask-mysql
          - name: flask-mysql-jwt
            path: flask-mysql_app
            script_dir: flask-mysql_app

        config:
          - name: record_latest_replay_build
            record_src: latest
            replay_src: build
          - name: record_build_replay_latest
            record_src: build
            replay_src: latest
          - name: record_build_replay_build
            record_src: build
            replay_src: build

    name: ${{ matrix.app.name }} (${{ matrix.config.name }})
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: record
        uses: ./.github/actions/download-binary
        with:
          src: ${{ matrix.config.record_src }}

      - id: replay
        uses: ./.github/actions/download-binary
        with:
          src: ${{ matrix.config.replay_src }}

      - name: Checkout the samples-python repository
        uses: actions/checkout@v4
        with:
          repository: officialasishkumar/samples-python
          path: samples-python

      - name: Run the ${{ matrix.app.name }} application
        id: run_tests
        env:
          RECORD_BIN: ${{ steps.record.outputs.path }}
          REPLAY_BIN: ${{ steps.replay.outputs.path }}
        run: |
          cd samples-python/${{ matrix.app.path }}

          source $GITHUB_WORKSPACE/.github/workflows/test_workflow_scripts/python/${{ matrix.app.script_dir }}/python-linux.sh

      - name: Collect and zip failure artifacts
        if: failure()
        run: |
          cd samples-python/${{ matrix.app.path }}

          # Create artifacts directory
          mkdir -p failure_artifacts

          # Copy all log files
          find . -name "*.txt" -type f -exec cp {} failure_artifacts/ \; 2>/dev/null || true
          find . -name "*.log" -type f -exec cp {} failure_artifacts/ \; 2>/dev/null || true

          # Copy keploy directory if it exists
          if [ -d "keploy" ]; then
            cp -r keploy failure_artifacts/
          fi

          # Copy docker logs if available
          docker compose logs > failure_artifacts/docker_logs.txt 2>/dev/null || true

          # Create a summary file with context
          cat > failure_artifacts/failure_summary.txt << EOF
          Job: ${{ matrix.app.name }} (${{ matrix.config.name }})
          Repository: ${{ github.repository }}
          PR Number: ${{ github.event.number }}
          Commit SHA: ${{ github.sha }}
          Commit Message: ${{ github.event.head_commit.message }}
          Branch: ${{ github.head_ref }}
          Author: ${{ github.actor }}
          Workflow Run ID: ${{ github.run_id }}
          Job URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          Timestamp: $(date -u)
          EOF

          # Create zip file
          zip -r failure_artifacts_${{ matrix.app.name }}_${{ matrix.config.name }}.zip failure_artifacts/

          echo "Created failure artifacts zip: failure_artifacts_${{ matrix.app.name }}_${{ matrix.config.name }}.zip"
          ls -la failure_artifacts_${{ matrix.app.name }}_${{ matrix.config.name }}.zip

      - name: Send failure notification email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: "smtp.gmail.com"
          server_port: 587
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "Keploy Python Test Failure - ${{ matrix.app.name }} (${{ matrix.config.name }})"
          to: asish.kumar@keploy.io
          from: GitHub Actions <${{ secrets.GMAIL_USERNAME }}>
          body: |
            The Keploy Python test has failed for the following configuration:

            ðŸ“‹ Test Details:
            - Job: ${{ matrix.app.name }} (${{ matrix.config.name }})
            - Repository: ${{ github.repository }}
            - PR Number: #${{ github.event.number }}
            - Commit SHA: ${{ github.sha }}
            - Branch: ${{ github.head_ref }}
            - Author: ${{ github.actor }}

            ðŸ”— Links:
            - Job URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - PR URL: ${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.number }}
            - Commit URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}

            ðŸ“Ž Attached Files:
            Please find the failure artifacts attached, including:
            - All log files from the test run
            - Keploy directory with test results and reports
            - Docker logs (if applicable)
            - Failure summary with context

            ðŸ•’ **Timestamp:** $(date -u)
          attachments: samples-python/${{ matrix.app.path }}/failure_artifacts_${{ matrix.app.name }}_${{ matrix.config.name }}.zip
