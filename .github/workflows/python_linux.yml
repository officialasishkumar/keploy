name: Python On Linux
on:
  workflow_call:

jobs:

  test-python-app:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app:
          - name: django-postgres
            path: django-postgres/django_postgres
            script_dir: django_postgres
          - name: flask-mysql-jwt
            path: flask-mysql_app
            script_dir: flask-mysql_app

        config:
          - name: record_latest_replay_build
            record_src: latest
            replay_src: build
          - name: record_build_replay_latest
            record_src: build
            replay_src: latest
          - name: record_build_replay_build
            record_src: build
            replay_src: build

    name: ${{ matrix.app.name }} (${{ matrix.config.name }})
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: record
        uses: ./.github/actions/download-binary
        with:
          src: ${{ matrix.config.record_src }}

      - id: replay
        uses: ./.github/actions/download-binary
        with:
          src: ${{ matrix.config.replay_src }}

      - name: Checkout the samples-python repository
        uses: actions/checkout@v4
        with:
          repository: officialasishkumar/samples-python
          path: samples-python

      - name: Create results directory
        run: mkdir -p results

      - name: Run the ${{ matrix.app.name }} application
        env:
          RECORD_BIN: ${{ steps.record.outputs.path }}
          REPLAY_BIN: ${{ steps.replay.outputs.path }}
        run: |
          set -o pipefail
          cd samples-python/${{ matrix.app.path }}
          source $GITHUB_WORKSPACE/.github/workflows/test_workflow_scripts/python/${{ matrix.app.script_dir }}/python-linux.sh 2>&1 | tee $GITHUB_WORKSPACE/results/output.log

      - name: Prepare test results
        if: always()
        run: |
          echo "Job: ${{ matrix.app.name }} (${{ matrix.config.name }})" > results/summary.txt
          echo "Status: ${{ job.status }}" >> results/summary.txt
          echo "See attached logs for details." >> results/summary.txt

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.app.name }}-${{ matrix.config.name }}
          path: results/


  send-summary-report:
    needs: test-python-app
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all test artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Prepare email content and attachments
        id: prep-email
        run: |
          # Create a comprehensive summary file
          echo "# Python Linux Tests Report" > summary_body.md
          echo "" >> summary_body.md
          echo "**Workflow Run:** [#${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> summary_body.md
          echo "**Repository:** ${{ github.repository }}" >> summary_body.md
          echo "**Branch:** ${{ github.ref_name }}" >> summary_body.md
          echo "**Timestamp:** $(date)" >> summary_body.md
          echo "" >> summary_body.md

          failed_count=0
          total_count=0
          attachment_paths=""

          echo "## Summary" >> summary_body.md
          echo "| Project | Configuration | Status |" >> summary_body.md
          echo "|---|---|---|" >> summary_body.md

          # Process all summary files from downloaded artifacts
          for summary_file in $(find all-results -type f -name 'summary.txt'); do
            total_count=$((total_count + 1))
            
            JOB_NAME=$(grep "Job:" "$summary_file" | sed 's/Job: //' | sed 's/ (.*//')
            JOB_CONFIG=$(grep "Job:" "$summary_file" | sed 's/.*(//' | sed 's/).*//')
            JOB_STATUS=$(grep "Status:" "$summary_file" | sed 's/Status: //')
            
            if [ "$JOB_STATUS" = "success" ]; then
              STATUS_ICON="✅ Success"
            else
              STATUS_ICON="❌ Failed"
              failed_count=$((failed_count + 1))
              # For failed jobs, zip the artifact directory and add it to attachments
              artifact_dir=$(dirname "$summary_file")
              zip_name="${artifact_dir}.zip"
              zip -r "$zip_name" "$artifact_dir"
              attachment_paths="${attachment_paths} ${zip_name}"
            fi
            echo "| ${JOB_NAME} | ${JOB_CONFIG} | ${STATUS_ICON} |" >> summary_body.md
          done

          echo "" >> summary_body.md
          echo "**Total Tests:** $total_count | **Failed:** $failed_count | **Passed:** $((total_count - failed_count))" >> summary_body.md

          if [ $failed_count -gt 0 ]; then
            echo "" >> summary_body.md
            echo "## 🚨 Failure Details" >> summary_body.md
            echo "" >> summary_body.md
            
            for summary_file in $(find all-results -type f -name 'summary.txt'); do
              JOB_STATUS=$(grep "Status:" "$summary_file" | sed 's/Status: //')
              
              if [ "$JOB_STATUS" != "success" ]; then
                JOB_NAME=$(grep "Job:" "$summary_file" | sed 's/Job: //' | sed 's/ (.*//')
                JOB_CONFIG=$(grep "Job:" "$summary_file" | sed 's/.*(//' | sed 's/).*//')
                
                echo "### ❌ ${JOB_NAME} (${JOB_CONFIG})" >> summary_body.md
                echo "**Status:** ${JOB_STATUS}" >> summary_body.md
                echo "" >> summary_body.md
                
                log_file=$(dirname "$summary_file")/output.log
                if [ -f "$log_file" ]; then
                  echo "**Last 30 lines of logs:**" >> summary_body.md
                  echo "\`\`\`" >> summary_body.md
                  tail -30 "$log_file" >> summary_body.md
                  echo "\`\`\`" >> summary_body.md
                fi
                echo "" >> summary_body.md
                echo "---" >> summary_body.md
                echo "" >> summary_body.md
              fi
            done
          fi

          # Set outputs for the next step
          echo "attachment_path=$(echo $attachment_paths | xargs)" >> $GITHUB_OUTPUT

          if [ $failed_count -gt 0 ]; then
            echo "email_subject=🚨 Python Tests FAILED ($failed_count/$total_count) - ${{ github.repository }} #${{ github.run_id }}" >> $GITHUB_OUTPUT
          else
            echo "email_subject=✅ Python Tests PASSED - ${{ github.repository }} #${{ github.run_id }}" >> $GITHUB_OUTPUT
          fi

      - name: Send summary email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: "smtp.gmail.com"
          server_port: "587"
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: ${{ steps.prep-email.outputs.email_subject }}
          body: file://summary_body.md
          to: ${{ secrets.RECIPIENT_EMAILS }}
          from: ${{ secrets.GMAIL_USERNAME }}
          # This ensures the email client renders the Markdown as HTML
          content_type: text/html
          # This now attaches only the zips of failed jobs
          attachments: ${{ steps.prep-email.outputs.attachment_path }}
